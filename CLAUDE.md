# CLAUDE.md

このファイルはClaude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## 基本方針

**重要**: この基本方針はClaude Codeがこのリポジトリで作業する際に必ず遵守すべき規則です。すべての作業においてこれらの方針に従って実行してください。

### 指示内容の分析

- **指示の理解と分類**: 依頼された内容を正確に理解し、調査・分析、設計・提案、実装・修正のどの段階の作業かを判断して作業の境界を明確にする
- **前提条件の確認**: 作業に必要な情報が不足している場合は、作業開始前に確認を求める
- **リスク評価**: 指示を実行することで問題が起きる懸念がある場合は、本当に作業を進めていいか確認する

### 作業実行の制約

- **指示外作業の禁止**: 明示的に指示されていない作業は実行しない
- **段階的な進行**: 各段階（調査→提案→合意→実装）で明示的な指示を待つ
- **提案への対応**: 「～はどうでしょうか？」「～してみませんか？」などの提案や疑問文に対しては、まず提案内容を整理して確認を求め、明示的な実装指示を待つ
- **事前ガイド参照**: 作業開始前に「[## 参照ガイドライン](#参照ガイドライン)」で該当するガイドを確認し、関連セクションを参照してから作業を開始する
- **最新情報の収集**: 作業開始前に可能な限りWebやMCPサーバーから最新の技術情報、ベストプラクティス、パッケージバージョンを収集してから作業を開始する
- **事前相談の徹底**: 以下に該当する場合は作業開始前に相談する
  - 該当するガイドがなく複数の実装方針が考えられる場合
  - ファイル構造やセクション構成の変更
  - 新しい方針やルールの追加・変更
  - 既存の内容を大幅に修正する場合
- **実施後の確認**: 作業完了後にガイドラインに沿った実装になっているかを確認し、逸脱がある場合は修正する

### 問題発生時の対応

- **即座の相談**: 作業中に想定外の問題や判断に迷う状況が発生した場合は、独断で進めず対応方針を相談する
- **現状報告**: 問題の内容、現在の作業状況、考えられる選択肢を整理して報告する
- **提案と選択**: 複数の解決策がある場合は、それぞれのメリット・デメリットを示して選択を求める

## 参照ガイドライン

**作業種別による参照先**：

- **Python アプリケーション実装時**: [Python開発ガイド](docs/development/python.md) を参照
  - プロジェクト開始時: 「## 環境構築」
  - 開発計画時: 「## 計画」
  - 設計実装時: 「## 設計」
  - コード実装時: 「## 実装」
  - テスト実装時: 「## テスト戦略」
  - デプロイ・運用時: 「## 運用・デプロイ」

- **Terraform インフラ構築時**: [Terraform開発ガイド](docs/development/terraform.md) を参照
  - 実装前: 環境構築（ツール準備、プロジェクト初期設定）
  - 実装中: 開発ガイドライン（コマンド、ワークフロー、ファイル構成、命名規則、リソース定義、機密情報取り扱い）
  - 実装後: 品質管理（コード品質・セキュリティ検証、バージョン・State管理）

- **AWS リソース操作時**: [AWS環境ガイド](docs/development/aws.md) を参照
  - 基本方針（Terraform構築、lambrollデプロイ、Secrets Manager運用）
  - 命名規則（組み合わせリソース・単独リソースのパターン）
  - 設計指針（AWS Well-Architectedフレームワーク準拠）

- **作業指示書作成・解釈時**: [作業指示書作成ガイド](docs/guides/instructions.md) を参照
  - 書き方（開発ゴール、機能一覧、開発の流れ、タスク）
  - タスク分割・順序の指針
  - 完了条件・検証方法の定義

- **ドキュメント作成時**: 「[## ドキュメントガイド](#ドキュメント方針)」を参照
  - 文書の役割分担（トピック定義、文書間連携、同一文書内例外）
  - 見出しの構成（読者フロー準拠、階層の統一性）
  - 記述方式（記載対象選別、判断基準明確化、情報一元化、表記一貫性、技術仕様）


## ドキュメントガイド

### 文書の役割分担

- **トピックの定義**：ひとつの文書では、読者が単一の目的・作業を完了するために必要な情報のみを扱い、異なる目的や独立実行可能な作業は別文書に分割する
- **文書間連携**：メイントピック外の事項はリンク付きの1-2行程度の言及に留め、分割した文書間では読者の作業フローを分断しないよう適切なナビゲーションを提供する
- **同一文書内で扱える例外**：メイントピック実行に必須のツール・環境設定、基本的なトラブルシューティング、最低限必要な前提知識

### 見出しの構成

- **読者フロー準拠**：見出しは読者が情報を参照するタイミングと順序に基づいて構成し、実際の作業フローに沿って情報をグループ化する
- **階層の統一性**：同一階層の見出しは、同じ抽象度・分類軸・表現形式で記述し、相互に排他的かつ網羅的な関係を保つ

### 記述方式

- **記載対象の選別**：運用ルールや設計方針など事前決定が必要で作業の一貫性に影響する内容のみ記載し、エラー対応など調査・検索で解決できる内容は記載しない
- **判断基準の明確化**：抽象的な記述を避け、Claude Codeが判断に迷わない程度の明確さで記載する
- **情報の一元化**：同一内容が複数箇所に重複記載されることを避ける
- **表記の一貫性**：技術用語は公式名称を使用し、設定値・命名規則・バージョン情報を文書内で統一する
- **技術仕様**：文字エンコーディングは日本語UTF-8で作成する

## プロジェクト構成

モノレポ構成で複数の技術領域を統合管理：

```
.
├── .devcontainer/     # 開発コンテナ設定
├── apps/              # アプリケーション（Slack Bot、Issue管理等）
├── terraform/         # インフラストラクチャ定義（AWS Bedrock、Lambda等）
├── aqua.yaml          # CLIツールのバージョン管理設定
├── compose.yaml       # Docker Compose設定
├── CLAUDE.md          # 開発ガイドライン（このファイル）
├── DESIGN.md          # システム全体のアーキテクチャ設計書
└── INSTRUCTIONS.md    # 作業指示・実装タスク
```

## 開発環境

### パッケージ管理

#### Aqua

**Aquaパッケージマネージャー**によるCLIツールのバージョン管理

```bash
aqua install      # aqua.yamlで定義されたツールをインストール
aqua list         # インストール済みツール一覧
aqua which <tool> # ツールのパスを表示
```

### 開発コンテナ

**VS Code Dev Container**による統一開発環境

```bash
# VS Code/Cursorでのコンテナ操作
Ctrl+Shift+P → "Dev Containers: Reopen in Container"     # コンテナで開く
Ctrl+Shift+P → "Dev Containers: Rebuild Container"       # コンテナ再構築
Ctrl+Shift+P → "Dev Containers: Reopen Locally"         # ローカルで開く
```

## AWS環境

AWS環境の詳細な設定・開発ガイドは専用ページを参照してください：

**[AWS環境ガイド](docs/development/aws.md)**

### 主な内容

- 基本方針（Terraform構築、lambrollデプロイ、Secrets Manager運用）
- 命名規則（組み合わせリソース・単独リソースのパターン）
- 設計指針（AWS Well-Architectedフレームワーク準拠）

## Terraform開発

Terraformの詳細な開発ガイドは専用ページを参照してください：

**[Terraform開発ガイド](docs/development/terraform.md)**

### 参照タイミングと主な内容

- **実装前**: 環境構築（ツール準備、プロジェクト初期設定）
- **実装中**: 開発ガイドライン（コマンド、ワークフロー、ファイル構成、命名規則、リソース定義、機密情報取り扱い）
- **実装後**: 品質管理（コード品質・セキュリティ検証、バージョン・State管理）

## Python開発

Pythonアプリケーションの詳細な開発ガイドは専用ページを参照してください：

**[Python開発ガイド](docs/development/python.md)**

### 参照タイミングと見出し

- **プロジェクト開始時**: 「## 環境構築」- 必要ツール、プロジェクト初期設定、ディレクトリ構成標準、命名規則
- **開発計画時**: 「## 計画」- 開発フロー、設計フェーズ手順
- **設計実装時**: 「## 設計」- アーキテクチャ設計、レイヤー分離、依存性注入設計、ファイル・クラス構成設計
- **コード実装時**: 「## 実装」- コード実装規則、品質基準、エラーハンドリング、ロギング
- **テスト実装時**: 「## テスト戦略」- ユニットテスト設計、結合テスト設計、テスト実行フロー
- **デプロイ・運用時**: 「## 運用・デプロイ」- デプロイ管理、Lambda関数デプロイ、運用監視

## 作業指示

作業指示書（INSTRUCTIONS.md）の詳細な作成ガイドは専用ページを参照してください：

**[作業指示書作成ガイド](docs/guides/instructions.md)**

### 主な内容

- 書き方（開発ゴール、機能一覧、開発の流れ、タスク）
- タスク分割・順序の指針
- 完了条件・検証方法の定義
- 人による作業依頼のワークフロー
- 具体例とベストプラクティス

#### タスク

##### タスク分割の指針

各タスクが単独で完了判定でき、他のタスクに影響しない粒度に調整する

以下が分割の例となる

- シークレットの格納場所の作成および人手による格納を一つのタスクとする
- Lambda関数等のアプリケーションのローカル実装からユニットテストを一つのタスクとする（大きい場合は分割可能）
- IAM・ログ等を含む一つのアプリケーションの実行基盤構築とデプロイを一つのタスクとする
- 複雑なAWSサービス（Bedrock Agent、Knowledge Base等）の構築は前提条件の準備と本体構築を分離する
- 定期実行などアプリ外の機能や、アプリケーション同士の組み合わせによる機能の実現を一つのタスクとする
- 開発ゴールを満たしていることの検証を一つのタスクとする

##### タスク順序の指針

**前後関係の決定原則**：

- **機能実装の前後関係**: 単一機能の実装・テスト完了後に、その機能を利用する上位機能を実装
- **サービス間の呼び出し関係**: 呼び出し先を先に構築してから呼び出し元を構築（例：Lambda関数のデプロイ→EventBridge Schedulerの設定）
- **データフローの上流下流**: データの提供側を先に構築してから利用側を構築（例：データベース作成→アプリケーション実装）
- **機密情報**: 機密情報を先に格納してからそれを利用するサービスを構築
- **前提条件の準備**: 複雑なサービスは前提条件（ダミーデータ、設定ファイル等）を先に準備してから本体を構築

**作業指示の詳細**: [作業指示書作成ガイド](docs/guides/instructions.md)
