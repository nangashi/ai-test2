# 作業指示書作成ガイド

このガイドでは、**INSTRUCTIONS.md**での作業指示記載方法について説明します。

## 書き方

### 開発ゴール

開発対象がどのようなシステムであるかを述べ、システムの設計がDESIGN.mdに定義されていることを伝える

### 機能一覧

実装の網羅性を確保するために、DESIGN.mdで定義されたアプリケーションを基準として実装単位を定義する

各機能はapps/ディレクトリのアプリケーション名と対応し、DESIGN.mdのアプリケーション一覧で詳細仕様を参照する

### 開発の流れ

一覧で示した機能の開発や、テストなどの検証タスクなど、開発をどのように進めるかを具体的に理由付きで説明する

例：

1. 認証機能の開発：API Key・トークン管理は各機能で利用するためここで実施する
2. データ収集機能：外部APIとの連携のみで他機能への依存がないためここで実施する
3. データ変換機能：データ収集機能で取得したデータを変換するため、データ収集機能の開発後に実施する
4. 開発ゴール検証：全機能の開発後に実施する

### タスク

各タスクは以下の構成要素で記載する：

- **タスク名**: 実施内容の簡潔な説明
- **完了条件**: 技術的状態、数値基準、設定値確認等の客観的判定基準
- **参照ドキュメント**: 実装時に参照すべき設計書、ガイド、外部リソースの箇条書き
- **検証方法**: Claude Codeが実行可能な具体的なコマンドと判定基準

#### タスク分割の指針

各タスクが単独で完了判定でき、他のタスクに影響しない粒度に調整する

以下が分割の例となる

- シークレットの格納場所の作成および人手による格納を一つのタスクとする
- Lambda関数等のアプリケーションのローカル実装からユニットテストを一つのタスクとする（大きい場合は分割可能）
- IAM・ログ等を含む一つのアプリケーションの実行基盤構築とデプロイを一つのタスクとする
- 複雑なAWSサービス（Bedrock Agent、Knowledge Base等）の構築は前提条件の準備と本体構築を分離する
- 定期実行などアプリ外の機能や、アプリケーション同士の組み合わせによる機能の実現を一つのタスクとする
- 開発ゴールを満たしていることの検証を一つのタスクとする

#### タスク順序の指針

**前後関係の決定原則**：

- **機能実装の前後関係**: 単一機能の実装・テスト完了後に、その機能を利用する上位機能を実装
- **サービス間の呼び出し関係**: 呼び出し先を先に構築してから呼び出し元を構築（例：Lambda関数のデプロイ→EventBridge Schedulerの設定）
- **データフローの上流下流**: データの提供側を先に構築してから利用側を構築（例：データベース作成→アプリケーション実装）
- **機密情報**: 機密情報を先に格納してからそれを利用するサービスを構築
- **前提条件の準備**: 複雑なサービスは前提条件（ダミーデータ、設定ファイル等）を先に準備してから本体を構築

#### 完了条件の定義

**完了時の状態の具体化**：

- **技術的状態**: 「デプロイされている」「権限が設定されている」「テストが成功している」等の客観的な状態
- **数値基準**: カバレッジ90%以上、HTTPステータス200等の具体的な判定基準
- **設定値確認**: DESIGN.mdの仕様との一致、必要な権限の付与等

#### 参照ドキュメントの明示

**各タスクで参照すべき情報源を明確化**：

- **設計仕様**: DESIGN.mdの該当セクション（アプリケーション仕様、API定義、データ構造等）
- **実装ガイド**: 技術別ガイド（[Terraform開発](../development/terraform.md)、[Python開発](../development/python.md)、[AWS環境](../development/aws.md)）
- **設定例**: 具体的なファイルパス、設定値、コマンド例の参照先
- **外部リソース**: AWS公式ドキュメント、ライブラリドキュメントの特定ページ

**検証方法の記載ルール**：

- **Claude Codeから実行可能**: CLIコマンド・API呼び出しのみ記載（Claude CodeはWebコンソールにアクセスできないため）
- **具体的コマンド**: `terraform apply`、`uv run pytest`、`curl [URL]`等の実際に実行するコマンドを明記
- **判定基準の明確化**: コマンド実行結果の具体的な成功/失敗判定基準を明示
  - **期待値**: HTTPステータス200、特定の設定値、レスポンスフィールドの存在等の具体的な値
  - **判定方法**: どのフィールド・プロパティで成功を判断するか（例：Status="ACTIVE"、Count > 0、Value != "dummy"等）
  - **数値条件**: 範囲、閾値、カウント等の具体的な数値基準（例：30以上、1-5の範囲等）
  - **文字列条件**: 完全一致、パターンマッチ、含有等の文字列判定基準（例：HTTPSで始まる、"FAILED"が含まれない等）
- **段階的検証**: 複雑なタスク（設定ファイル作成、スキーマ定義等）では検証を段階的に記載
  - 箇条書き形式で順序立てて検証手順を明記
  - 各段階で確認する具体的な値・状態・プロパティと期待値を明記
  - DESIGN.mdの設定詳細セクション等の参照すべき仕様を明示
  - 成功時の期待値と判定条件を明記
- **人による作業依頼**: Claude Codeでは実行不可能な作業（外部トークン生成、手動設定、UI確認等）は人に作業・検証を依頼し、完了報告後にClaude Codeが可能な範囲で結果を検証することを明記
- **進捗管理**: タスク完了時にMarkdownチェックボックスを更新し、進捗を可視化
  - 各タスクは`- [ ]`形式のチェックボックスで記載
  - タスク完了後は検証方法を実行し、全て成功した場合に`- [x]`へ更新
  - 進捗状況を明確にするため、完了時には「タスク完了: [タスク名]」をメッセージで報告

### 人による作業依頼のワークフロー

**人による作業が必要な場合の標準的な流れ**：

1. **Claude Codeによる依頼**: 明確な作業内容・検証手順をメッセージで提示
2. **人による作業・検証実行**: 外部サービスでの設定、トークン生成、動作確認等
3. **人による完了報告**: 作業・検証完了をClaude Codeに報告
4. **Claude Codeによる補完確認**: 可能な範囲でAWS CLIやAPIで結果を確認

**パターン別の例**：

**作業＋Claude Code検証パターン**：

```
以下の手動作業をお願いします：

1. GitHubでPersonal Access Tokenを生成
   - Settings > Developer settings > Personal access tokens
   - スコープ: repo, issues
2. 生成されたトークンを以下のコマンドで設定
   - aws secretsmanager update-secret --secret-id dev-github-pat --secret-string "ghp_xxxxxxxxxxxx"
3. 完了したら「GitHub PAT設定完了」とお知らせください

完了報告後、Claude CodeがAWS CLIでトークン設定を確認します。
```

**作業＋人による検証パターン**：

```
以下の手動作業・検証をお願いします：

1. SlackワークスペースでBotにメンション送信
2. GitHubリポジトリに新しいIssueが作成されることを確認
3. 動作確認完了したら「Slack連携動作確認完了」とお知らせください

Claude Codeでは外部サービス間の連携確認ができないため、人による検証をお願いします。
```

### 補足情報の定義

**参考情報**：

- **設計書参照**: DESIGN.mdの該当セクションを明記
- **実装ガイド参照**: 技術セクション（[Terraform開発](../development/terraform.md)、[Python開発](../development/python.md)、[AWS環境](../development/aws.md)等）を明記
- **実装ルール**: [CLAUDE.md](../../CLAUDE.md)の命名規則、ディレクトリ構成、開発方針に従うことを明記
- **特記事項**: 実装時の注意点・制約事項を明記

**注意**: 各タスクの「参照ドキュメント」項目で具体的な参照先を個別に指定するため、参考情報セクションは全体的な補足に留める

**全体完了条件**：

- **機能完全性**: DESIGN.mdで定義された全機能の動作確認
- **フロー完全性**: エンドツーエンドの全体フローの成功確認
- **品質確保**: 全テストの成功とAWS環境での安定動作

## 具体例

```markdown
# 作業指示

## データ処理システムの実装

## 開発ゴール
DESIGN.mdで定義されたデータ処理システム全体を実装し、設計書通りの完全なシステムを構築する

### 機能一覧
- **データ収集アプリケーション (data_collector)**: 外部APIからのデータ取得
- **データ変換アプリケーション (data_transformer)**: データ形式変換・クレンジング
- **レポート生成アプリケーション (report_generator)**: 集計結果の出力

## 開発の流れ
1. **認証・権限基盤の構築**: API Key管理など各アプリケーションで利用する基盤のため最初に実施
2. **データ収集アプリケーション**: 外部APIとの連携のみで他アプリケーションへの依存がないためここで実施
3. **データ変換アプリケーション**: データ収集アプリケーションで取得したデータを変換するため、データ収集の完了後に実施
4. **統合テスト**: 全アプリケーション完了後に全体フローを検証

## タスク

### 1. 基盤構築
- [ ] **Secrets Manager作成**: API Key格納場所の作成とダミー値設定
  - 完了条件: Secrets Managerにダミー値が格納されている
  - 参照ドキュメント: 
    - [AWS環境ガイド](../development/aws.md#基本方針) - Secrets Manager運用方針
    - [Terraform開発ガイド](../development/terraform.md) - リソース定義方法
  - 検証方法: `aws secretsmanager get-secret-value`コマンドでSecretStringが"dummy"であることを確認
- [ ] **API Key手動設定**: 外部サービスから取得したAPI Keyの格納
  - 完了条件: API Keyが実際の値で格納されている
  - 参照ドキュメント:
    - DESIGN.md - 外部サービス連携仕様、必要なスコープ・権限
    - [AWS環境ガイド](../development/aws.md#設計指針) - シークレット管理方針
  - 検証方法: 
    1. 人による作業を依頼（外部サービスでAPI Key生成し、`aws secretsmanager update-secret`コマンドで更新）
    2. 完了報告後に`aws secretsmanager get-secret-value`でSecretStringが"dummy"でないことを確認
    3. SecretStringの長さが20文字以上であることを確認
    4. 外部APIエンドポイントへのHTTP GETリクエストでHTTPステータス200が返されることを確認
- [ ] **IAMロール・ポリシー作成**: Lambda実行に必要な権限設定
  - 完了条件: 必要な権限が設定されている
  - 参照ドキュメント:
    - [AWS環境ガイド](../development/aws.md#設計指針) - 最小権限の原則、IAM設計方針
    - [Terraform開発ガイド](../development/terraform.md#ファイル分割方針) - IAMリソースの配置方法
    - DESIGN.md - アプリケーション別の必要権限一覧
  - 検証方法: `aws iam list-attached-role-policies`でポリシーが1つ以上アタッチされ、`aws iam get-policy-version`でAction配列に"secretsmanager:GetSecretValue"が含まれることを確認

### 2. データ収集アプリケーション
- [ ] **ローカル実装**: 外部API連携機能の実装・テスト
  - 完了条件: ユニットテストが全て成功する
  - 参照ドキュメント:
    - [Python開発ガイド](../development/python.md#実装ガイドライン) - コード構成・品質基準
    - [Python開発ガイド](../development/python.md#テスト方針) - テスト実装方針
    - DESIGN.md - アプリケーション仕様（data_collector）、入出力定義
  - 検証方法: `uv run pytest --cov=src` でテスト実行し、出力に"FAILED"が含まれず、全テストが"PASSED"と表示され、カバレッジが90%以上であることを確認
- [ ] **設定ファイル作成**: 外部API連携用の設定定義
  - 完了条件: 設定ファイルがDESIGN.md仕様に準拠して作成されている
  - 検証方法:
    1. 指定パス（`config/api-config.json`）にファイルが存在することを確認
    2. `jq '.' config/api-config.json` でパースエラーが発生しないことを確認
    3. `jq '.endpoint' config/api-config.json` で"https://"で始まるURL文字列が返されることを確認
    4. `jq '.timeout' config/api-config.json` で30以上の数値が返されることを確認
    5. `jq '.retries' config/api-config.json` で1-5の範囲の数値が返されることを確認
- [ ] **デプロイと動作確認**: AWS環境での動作確認
  - 完了条件: AWS環境で正常に動作する
  - 検証方法: 
    1. `lambroll deploy`コマンドが終了コード0で完了することを確認
    2. `aws lambda get-function`でStateが"Active"であることを確認
    3. `aws lambda get-function`のConfiguration.RoleがIAMロールのARNと一致することを確認
    4. `aws logs filter-log-events`でエラーログが存在しないことを確認

### 3. 統合テスト
- [ ] **全体フロー確認**: データ収集→変換→出力の全体フロー確認
  - 完了条件: 設計書通りの全体フローが動作する
  - 検証方法: 
    1. `aws lambda invoke`でテストデータを使用した全工程実行
    2. `aws s3 ls`でS3バケットに結果ファイルが1つ以上存在することを確認
    3. `aws s3 cp`でファイルをダウンロードし、`jq '.' filename.json`で有効なJSON形式であることを確認
    4. `jq 'keys | length' filename.json`で期待するフィールド数（5個以上）が含まれることを確認
- [ ] **外部API連携確認**: 実際の外部サービスとの連携動作確認
  - 完了条件: 外部APIから正常にデータが取得できる
  - 検証方法: 
    1. 人による検証を依頼（外部サービスの管理画面でAPI呼び出し履歴を確認）
    2. HTTPステータス200のレスポンスが記録され、レスポンスサイズが1KB以上であることを確認
    3. レスポンスボディに期待するデータフィールド（user_id、timestamp等）が含まれていることを確認
    4. `aws logs filter-log-events`でLambda実行ログに"SUCCESS"が含まれ、"ERROR"が含まれないことを確認

### 参考情報
- 設計書: DESIGN.md の該当セクション
- 実装ガイド: docs/development/ の技術別ガイド
- 実装ルール: CLAUDE.md の命名規則、ディレクトリ構成、基本方針に従う

### 全体完了条件
- DESIGN.mdで定義された全機能が設計書通りに動作すること
- 全てのテストが成功すること

### 進捗管理の例

タスク完了時のワークフロー：

1. **検証方法の実行**: 完了条件に記載された全ての検証を実行
2. **チェックボックスの更新**: 全て成功した場合、`- [ ]`を`- [x]`に変更
3. **完了報告**: 「タスク完了: [タスク名]」をメッセージで報告

例：
```markdown
- [x] **Secrets Manager作成**: API Key格納場所の作成とダミー値設定
  - 完了条件: Secrets Managerにダミー値が格納されている
  - 検証方法: `aws secretsmanager get-secret-value`コマンドでSecretStringが"dummy"であることを確認
```

タスク完了: Secrets Manager作成
```

## 参考情報

- **設計書**: [DESIGN.md](../../DESIGN.md)